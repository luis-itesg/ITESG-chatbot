<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal Estudiantil ITESG — Justificantes · Titulación · Residencias</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2a; --muted:#9fb1d0; --text:#eaf2ff; --accent:#59a6ff; --ok:#25c08a; --warn:#f0b429; --err:#ff6b6b; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{font-size:22px;margin:0 0 8px 0;display:flex;align-items:center;gap:12px}
    p.lead{color:var(--muted);margin:0 0 24px 0}
    .card{background:var(--card);border:1px solid #1d2a41;border-radius:16px;padding:16px;margin-bottom:16px}
    .title{font-weight:700;margin:0 0 10px 0}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;background:#0c1627;border:1px solid #1f2b45;color:var(--text);border-radius:10px;outline:none}
    textarea{resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{appearance:none;border:none;background:var(--accent);color:#08111f;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{background:#1d2a41;color:var(--text);border:1px solid #2a3a5d}
    .muted{color:var(--muted);font-size:12px}
    .status{margin-top:10px;font-size:14px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    a{color:var(--accent)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #1d2a41;background:#101a2b;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--accent);color:#08111f;border-color:transparent}
    .hidden{display:none}
    #chatBox{max-height:300px;overflow-y:auto;padding:12px;background:#0c1627;border:1px solid #1f2b45;border-radius:10px;margin-bottom:10px}
    .msg{margin:6px 0;padding:8px 12px;border-radius:12px;max-width:75%}
    .user{background:#59a6ff;color:#08111f;margin-left:auto}
    .bot{background:#1d2a41;color:#eaf2ff;margin-right:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      <img src="logo.png" alt="Logo ITESG" style="height:40px">
      Portal Estudiantil ITESG — Justificantes · Titulación · Residencias
    </h1>
    <p class="lead">Consulta pasos oficiales, descarga formatos y chatea con el asistente. <em>Powered by Ingeniería Industrial ITESG</em>.</p>

    <!-- NAV TABS -->
    <div class="tabs">
      <button class="tab active" data-tab="tab-chat">Chat (IA)</button>
      <button class="tab" data-tab="tab-justificantes">Justificantes</button>
      <button class="tab" data-tab="tab-residencias">Residencias</button>
      <button class="tab" data-tab="tab-titulacion">Solicitud de Titulación</button>
      <button class="tab" data-tab="tab-seguimiento">Seguimiento</button>
      <button class="tab" data-tab="tab-anexo1">Registro Proyecto (Anexo I)</button>
      <button class="tab" data-tab="tab-asesorias">Asesorías de Titulación</button>
      <button class="tab" data-tab="tab-config">Config</button>
    </div>
    <!-- CHAT -->
    <section id="tab-chat" class="tabpage">
      <div class="card">
        <h2 class="title">Chat con el asistente (IA)</h2>
        <div id="chatBox"></div>
        <form id="chatForm" style="display:flex;gap:8px">
          <input id="chatInput" placeholder="Escribe tu pregunta..." style="flex:1" />
          <button class="btn" type="submit">Enviar</button>
        </form>
      </div>
    </section>

    <!-- JUSTIFICANTES -->
    <section id="tab-justificantes" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Generar justificante</h2>
        <form id="formJustificante">
          <input type="hidden" id="tipoJ" value="justificante" />
          <label for="nombreJ">Nombre completo</label>
          <input id="nombreJ" required />
          <label for="matriculaJ">Matrícula</label>
          <input id="matriculaJ" />
          <label for="numControlJ">Número de control</label>
          <input id="numControlJ" />
          <label for="motivoJ">Motivo</label>
          <textarea id="motivoJ"></textarea>
          <label for="fechaJ">Fecha</label>
          <input id="fechaJ" type="date" />
          <label for="asignaturasJ">Asignaturas y docentes involucrados</label>
          <textarea id="asignaturasJ"></textarea>

          <!-- DÍAS DE INASISTENCIA -->
          <h3 class="title" style="margin-top:14px">Días de inasistencia (hasta 3 filas)</h3>
          <!-- Fila 1 -->
          <div class="row">
            <div><label for="d1del">Días del</label><input id="d1del" /></div>
            <div><label for="d1al">al</label><input id="d1al" /></div>
          </div>
          <div class="row3">
            <div><label for="mes1">Mes</label><input id="mes1" /></div>
            <div><label for="h1de">Horario de</label><input id="h1de" /></div>
            <div><label for="h1a">a</label><input id="h1a" /></div>
          </div>
          <!-- Fila 2 -->
          <div class="row">
            <div><label for="d2del">Días del</label><input id="d2del" /></div>
            <div><label for="d2al">al</label><input id="d2al" /></div>
          </div>
          <div class="row3">
            <div><label for="mes2">Mes</label><input id="mes2" /></div>
            <div><label for="h2de">Horario de</label><input id="h2de" /></div>
            <div><label for="h2a">a</label><input id="h2a" /></div>
          </div>
          <!-- Fila 3 -->
          <div class="row">
            <div><label for="d3del">Días del</label><input id="d3del" /></div>
            <div><label for="d3al">al</label><input id="d3al" /></div>
          </div>
          <div class="row3">
            <div><label for="mes3">Mes</label><input id="mes3" /></div>
            <div><label for="h3de">Horario de</label><input id="h3de" /></div>
            <div><label for="h3a">a</label><input id="h3a" /></div>
          </div>

          <p class="muted">Nota: Adjunta evidencia (ejemplo: justificante médico). Envíalo también a tu tutor y coordinador.</p>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar PDF</button></div>
        </form>
        <div id="outJustificante" class="status"></div>
      </div>
    </section>

    <!-- TITULACION -->
    <section id="tab-titulacion" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Generar solicitud de titulación</h2>
        <form id="formTitulacion">
          <input type="hidden" id="tipoT" value="titulacion_solicitud" />
          <label for="planT">Plan de estudios</label>
          <select id="planT">
            <option value="plan2004">Plan 2004</option>
            <option value="plan2010">Plan 2010</option>
          </select>
          <label for="opcionT">Opción de titulación</label>
          <select id="opcionT"></select>
          <div id="opcionHintT" class="muted"></div>
          <label for="nombreT">Nombre completo</label>
          <input id="nombreT" required />
          <label for="matriculaT">Matrícula</label>
          <input id="matriculaT" />
          <p class="muted">Adjunta certificado, servicio social, inglés y constancia de puntos. Si no, envíalos a <strong>ltorres@itesg.edu.mx</strong>.</p>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar solicitud</button></div>
        </form>
        <div id="outTitulacion" class="status"></div>
      </div>
    </section>

    <!-- RESIDENCIAS -->
    <section id="tab-residencias" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Generar solicitud de residencias</h2>
        <form id="formResidencias">
          <input type="hidden" id="tipoR" value="residencias_solicitud" />
          <label for="nombreR">Nombre completo</label>
          <input id="nombreR" required />
          <label for="matriculaR">Matrícula</label>
          <input id="matriculaR" />
          <label for="empresaR">Empresa</label>
          <input id="empresaR" />
          <label for="proyectoR">Proyecto</label>
          <input id="proyectoR" />
          <p class="muted">Adjunta Carta de presentación, Anteproyecto, Carta de agradecimiento y Kardex.</p>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar solicitud</button></div>
        </form>
        <div id="outResidencias" class="status"></div>
      </div>
    </section>

    <!-- SEGUIMIENTO -->
    <section id="tab-seguimiento" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Seguimiento a Asesorías de Titulación</h2>
        <p class="muted">Formato de reporte de asesorías (llenado por asesores y estudiantes en conjunto).</p>
      </div>
    </section>

    <!-- ANEXO I -->
    <section id="tab-anexo1" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Registro de Proyecto (Anexo I)</h2>
        <p class="muted">Formato de registro de proyecto para titulación (se llena a mano por estudiantes y asesores).</p>
      </div>
    </section>

    <!-- ASESORÍAS -->
    <section id="tab-asesorias" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Asesorías de Titulación</h2>
        <p class="muted">Aquí se consultan los reportes de asesorías. El llenado es manual en los formatos oficiales.</p>
      </div>
    </section>
    <!-- CONFIG -->
    <section id="tab-config" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Configurar webhooks</h2>
        <label for="wF">Webhook Formatos (POST)</label>
        <input id="wF" placeholder="https://tu-dominio/webhook/formatos" />
        <label for="wQ">Webhook Chat/Q&A (POST)</label>
        <input id="wQ" placeholder="https://tu-dominio/webhook/qa" />
        <label for="wS">Webhook Estado Titulación (POST)</label>
        <input id="wS" placeholder="https://tu-dominio/webhook/titulacion/estado" />
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="saveCfg" class="btn">Guardar</button>
          <button id="resetCfg" class="btn secondary">Reset</button>
        </div>
        <div id="cfgStatus" class="status muted" style="margin-top:8px"></div>
      </div>
    </section>

    <p class="muted">Privacidad: esta página no publica horarios de docentes ni listados de grupos. Solo procesos y formatos.</p>
  </div> <!-- /.wrap -->

  <script>
    /* ---------- TABS ---------- */
    const tabs = document.querySelectorAll('.tab');
    const pages = document.querySelectorAll('.tabpage');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      pages.forEach(p=>p.classList.add('hidden'));
      t.classList.add('active');
      document.getElementById(t.dataset.tab).classList.remove('hidden');
    }));

    /* ---------- CONFIG (localStorage) ---------- */
    const $wF = document.getElementById('wF');
    const $wQ = document.getElementById('wQ');
    const $wS = document.getElementById('wS');
    const $cfgStatus = document.getElementById('cfgStatus');
    const WKEY_F='webhook_formatos';
    const WKEY_Q='webhook_qa';
    const WKEY_S='webhook_estado';

    function loadCfg(){
      if ($wF) $wF.value = localStorage.getItem(WKEY_F)||'';
      if ($wQ) $wQ.value = localStorage.getItem(WKEY_Q)||'';
      if ($wS) $wS.value = localStorage.getItem(WKEY_S)||'';
      if ($cfgStatus){
        $cfgStatus.textContent = `Usando → Formatos: ${$wF?.value||'(sin)'} | Chat: ${$wQ?.value||'(sin)'} | Estado: ${$wS?.value||'(sin)'}`;
      }
    }
    function saveCfg(){
      if ($wF) localStorage.setItem(WKEY_F, ($wF.value||'').trim());
      if ($wQ) localStorage.setItem(WKEY_Q, ($wQ.value||'').trim());
      if ($wS) localStorage.setItem(WKEY_S, ($wS.value||'').trim());
      loadCfg();
    }
    function resetCfg(){
      localStorage.removeItem(WKEY_F);
      localStorage.removeItem(WKEY_Q);
      localStorage.removeItem(WKEY_S);
      loadCfg();
    }
    document.getElementById('saveCfg')?.addEventListener('click', e=>{ e.preventDefault(); saveCfg(); });
    document.getElementById('resetCfg')?.addEventListener('click', e=>{ e.preventDefault(); resetCfg(); });
    loadCfg();

    /* ---------- HELPERS ---------- */
    const j = id => document.getElementById(id);
    async function postJSON(url, body){
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    /* ---------- JUSTIFICANTES (con días/mes/horarios) ---------- */
    j('formJustificante')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const url = localStorage.getItem(WKEY_F);
      const out = j('outJustificante');
      if(!url){ out.textContent='Configura webhook formatos'; return; }

      const payload = {
        tipo: j('tipoJ').value,
        nombre: j('nombreJ').value,
        matricula: j('matriculaJ').value,
        numero_control: j('numControlJ').value,
        motivo: j('motivoJ').value,
        fecha: j('fechaJ').value,
        asignaturas: j('asignaturasJ').value,
        // Fila 1
        d1del: j('d1del')?.value||'', d1al: j('d1al')?.value||'', mes1: j('mes1')?.value||'',
        h1de: j('h1de')?.value||'',   h1a:  j('h1a')?.value||'',
        // Fila 2
        d2del: j('d2del')?.value||'', d2al: j('d2al')?.value||'', mes2: j('mes2')?.value||'',
        h2de: j('h2de')?.value||'',   h2a:  j('h2a')?.value||'',
        // Fila 3
        d3del: j('d3del')?.value||'', d3al: j('d3al')?.value||'', mes3: j('mes3')?.value||'',
        h3de: j('h3de')?.value||'',   h3a:  j('h3a')?.value||'',
      };

      out.textContent='Generando…';
      try{
        const d = await postJSON(url, payload);
        out.innerHTML = d?.ok ? `✅ <a href="${d.fileUrl}" target="_blank" rel="noopener">Descargar</a>` : 'Error en servidor';
      }catch(err){ out.textContent = String(err); }
    });

    /* ---------- TITULACIÓN (solicitud) ---------- */
    j('formTitulacion')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const url = localStorage.getItem(WKEY_F);
      const out = j('outTitulacion');
      if(!url){ out.textContent='Configura webhook formatos'; return; }

      const payload = {
        tipo: j('tipoT').value,
        plan: j('planT').value,
        opcion: j('opcionT').value,
        nombre: j('nombreT').value,
        matricula: j('matriculaT').value
      };

      out.textContent='Generando…';
      try{
        const d = await postJSON(url, payload);
        out.innerHTML = d?.ok ? `✅ <a href="${d.fileUrl}" target="_blank" rel="noopener">Descargar</a>` : 'Error';
      }catch(err){ out.textContent = String(err); }
    });

    /* Catálogos de opciones por plan */
    const OPCIONES_2004 = [
      {v:'tesis', t:'Tesis'},
      {v:'material_didactico', t:'Elaboración de texto o materiales didácticos'},
      {v:'proyecto_investigacion', t:'Proyecto de investigación'},
      {v:'curso_especial', t:'Curso especial de titulación'},
      {v:'examen_areas_na', t:'Examen por áreas de conocimiento (N/A)'},
      {v:'memoria_experiencia', t:'Memoria de experiencia profesional'},
      {v:'escolaridad_na', t:'Escolaridad (Aprovechamiento Académico) (N/A)'},
      {v:'creditos_posgrado_na', t:'Créditos de posgrado (N/A)'},
      {v:'memoria_residencia', t:'Memoria de residencia profesional'},
      {v:'titulacion_integrada', t:'Titulación Integrada'}
    ];
    const OPCIONES_2010 = [
      {v:'tesis_tesina', t:'Tesis o Tesina'},
      {v:'innovacion_tecnologica', t:'Proyecto de Innovación Tecnológica'},
      {v:'inv_o_desarrollo_tec', t:'Proyecto de Investigación o Desarrollo Tecnológico'},
      {v:'emprendedurismo', t:'Proyecto de Emprendedurismo'},
      {v:'examen_areas_egel_na', t:'Examen por áreas (Testimonio Satisfactorio/Sobresaliente EGEL, N/A)'},
      {v:'estancia', t:'Estancia'},
      {v:'proyecto_integrador', t:'Proyecto Integrador'},
      {v:'proyecto_productivo', t:'Proyecto Productivo'},
      {v:'memoria_residencia', t:'Memoria de residencia profesional'},
      {v:'dual', t:'Proyecto Integral de Educación Dual'}
    ];
    const HINTS_OPCION = {
      examen_areas_na: 'Marcado como N/A en el formato; verificar políticas vigentes.',
      escolaridad_na: 'Marcado como N/A; sujeto a lineamientos del campus.',
      creditos_posgrado_na: 'Marcado como N/A; revisar disposiciones actuales.',
      examen_areas_egel_na: 'Marcado como N/A en el formato (EGEL).',
      memoria_residencia: 'Se basa en el informe de residencias y su liberación.'
    };

    const selPlan = j('planT');
    const selOpcion = j('opcionT');
    const hintOpcion = j('opcionHintT');

    function renderOpciones(){
      if(!selPlan || !selOpcion) return;
      const list = selPlan.value === 'plan2010' ? OPCIONES_2010 : OPCIONES_2004;
      selOpcion.innerHTML = '';
      for(const opt of list){
        const o = document.createElement('option');
        o.value = opt.v; o.textContent = opt.t; selOpcion.appendChild(o);
      }
      updateOpcionHint();
    }
    function updateOpcionHint(){
      if(!selOpcion || !hintOpcion) return;
      const v = selOpcion.value;
      hintOpcion.textContent = HINTS_OPCION[v] || '';
    }
    selPlan?.addEventListener('change', renderOpciones);
    selOpcion?.addEventListener('change', updateOpcionHint);
    renderOpciones();

    /* ---------- RESIDENCIAS (solicitud) ---------- */
    j('formResidencias')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const url = localStorage.getItem(WKEY_F);
      const out = j('outResidencias');
      if(!url){ out.textContent='Configura webhook formatos'; return; }

      const payload = {
        tipo: j('tipoR').value,
        nombre: j('nombreR').value,
        matricula: j('matriculaR').value,
        empresa: j('empresaR').value,
        proyecto: j('proyectoR').value
      };

      out.textContent = 'Generando…';
      try{
        const d=await postJSON(url, payload);
        out.innerHTML = d?.ok ? `✅ <a href="${d.fileUrl}" target="_blank" rel="noopener">Descargar</a>` : 'Error';
      }catch(err){ out.textContent = String(err); }
    });

    /* ---------- CHAT (Q&A) ---------- */
    const chatBox = j('chatBox');
    j('chatForm')?.addEventListener('submit', async e=>{
      e.preventDefault();
      const url = localStorage.getItem(WKEY_Q);
      if(!url){ alert('Configura webhook Q&A primero'); return; }
      const txt = j('chatInput').value.trim();
      if(!txt) return;

      const userMsg = document.createElement('div');
      userMsg.className='msg user';
      userMsg.textContent = txt;
      chatBox.appendChild(userMsg);
      j('chatInput').value='';
      chatBox.scrollTop = chatBox.scrollHeight;

      try{
        const d = await postJSON(url, { q: txt });
        const botMsg = document.createElement('div');
        botMsg.className='msg bot';
        botMsg.textContent = d?.answer || '(sin respuesta)';
        chatBox.appendChild(botMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
      }catch(err){
        const botMsg = document.createElement('div');
        botMsg.className='msg bot';
        botMsg.textContent = 'Error: '+ String(err);
        chatBox.appendChild(botMsg);
      }
    });
  </script>
</body>
</html>
