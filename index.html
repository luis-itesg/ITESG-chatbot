<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal Estudiantil ITESG — Justificantes · Titulación · Residencias</title>
  <style>
    :root{--bg:#0b1220;--card:#111a2a;--muted:#9fb1d0;--text:#eaf2ff;--accent:#59a6ff;--ok:#25c08a;--warn:#f0b429;--err:#ff6b6b}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{font-size:22px;margin:0 0 8px 0;display:flex;align-items:center;gap:14px}
    .logo{height:92px;width:auto} /* logo más grande */
    p.lead{color:var(--muted);margin:0 0 24px 0}
    .card{background:var(--card);border:1px solid #1d2a41;border-radius:16px;padding:16px;margin-bottom:16px}
    .title{font-weight:700;margin:0 0 10px 0}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;background:#0c1627;border:1px solid #1f2b45;color:var(--text);border-radius:10px;outline:none}
    textarea{resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{appearance:none;border:none;background:var(--accent);color:#08111f;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    .status{margin-top:10px;font-size:14px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    a{color:var(--accent)}
    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #1d2a41;background:#101a2b;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--accent);color:#08111f;border-color:transparent}
    .hidden{display:none}
    /* Chat */
    #chatBox{max-height:300px;overflow-y:auto;padding:12px;background:#0c1627;border:1px solid #1f2b45;border-radius:10px;margin-bottom:10px}
    .msg{margin:6px 0;padding:8px 12px;border-radius:12px;max-width:75%}
    .user{background:#59a6ff;color:#08111f;margin-left:auto}
    .bot{background:#1d2a41;color:#eaf2ff;margin-right:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      <img src="logo.png" alt="Logo ITESG" class="logo">
      Portal Estudiantil ITESG — Justificantes · Titulación · Residencias
    </h1>
    <p class="lead">Consulta pasos oficiales, descarga formatos y chatea con el asistente. <em>Powered by Ingeniería Industrial ITESG</em>.</p>

    <!-- NAV TABS (sin Config, orden correcto) -->
    <div class="tabs">
      <button class="tab active" data-tab="tab-chat">Chat (IA)</button>
      <button class="tab" data-tab="tab-justificantes">Justificantes</button>
      <button class="tab" data-tab="tab-residencias">Residencias</button>
      <button class="tab" data-tab="tab-titulacion">Solicitud de Titulación</button>
      <button class="tab" data-tab="tab-seguimiento">Seguimiento</button>
      <button class="tab" data-tab="tab-anexo1">Registro Proyecto (Anexo I)</button>
      <button class="tab" data-tab="tab-asesorias">Asesorías de Titulación</button>
    </div>

    <!-- CHAT -->
    <section id="tab-chat" class="tabpage">
      <div class="card">
        <h2 class="title">Chat con el asistente (IA)</h2>
        <div id="chatBox"></div>
        <form id="chatForm" style="display:flex;gap:8px">
          <input id="chatInput" placeholder="Escribe tu pregunta..." style="flex:1" />
          <button class="btn" type="submit">Enviar</button>
        </form>
      </div>
    </section>
    <!-- JUSTIFICANTES -->
    <section id="tab-justificantes" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Generar justificante</h2>
        <form id="formJustificante">
          <input type="hidden" id="tipoJ" value="justificante" />

          <label for="nombreJ">Nombre completo</label>
          <input id="nombreJ" required />

          <label for="numControlJ">Número de control</label>
          <input id="numControlJ" required />

          <label for="motivoJ">Motivo</label>
          <textarea id="motivoJ" rows="2"></textarea>

          <label for="fechaJ">Fecha</label>
          <input id="fechaJ" type="date" />

          <label for="asignaturasJ">Asignaturas y docentes involucrados</label>
          <textarea id="asignaturasJ" rows="2"></textarea>

          <h3 class="title" style="margin-top:14px">Días de inasistencia (hasta 3 filas)</h3>

          <!-- Fila 1 -->
          <div class="row">
            <div>
              <label for="d1del">Días del</label>
              <input id="d1del" placeholder="ej. 10" />
            </div>
            <div>
              <label for="d1al">al</label>
              <input id="d1al" placeholder="ej. 12" />
            </div>
          </div>
          <div class="row3">
            <div>
              <label for="mes1">Mes</label>
              <input id="mes1" placeholder="ej. Septiembre" />
            </div>
            <div>
              <label for="h1de">Horario de</label>
              <input id="h1de" placeholder="ej. 08:00" />
            </div>
            <div>
              <label for="h1a">a</label>
              <input id="h1a" placeholder="ej. 10:00" />
            </div>
          </div>

          <!-- Fila 2 -->
          <div class="row" style="margin-top:6px">
            <div>
              <label for="d2del">Días del</label>
              <input id="d2del" />
            </div>
            <div>
              <label for="d2al">al</label>
              <input id="d2al" />
            </div>
          </div>
          <div class="row3">
            <div>
              <label for="mes2">Mes</label>
              <input id="mes2" />
            </div>
            <div>
              <label for="h2de">Horario de</label>
              <input id="h2de" />
            </div>
            <div>
              <label for="h2a">a</label>
              <input id="h2a" />
            </div>
          </div>

          <!-- Fila 3 -->
          <div class="row" style="margin-top:6px">
            <div>
              <label for="d3del">Días del</label>
              <input id="d3del" />
            </div>
            <div>
              <label for="d3al">al</label>
              <input id="d3al" />
            </div>
          </div>
          <div class="row3">
            <div>
              <label for="mes3">Mes</label>
              <input id="mes3" />
            </div>
            <div>
              <label for="h3de">Horario de</label>
              <input id="h3de" />
            </div>
            <div>
              <label for="h3a">a</label>
              <input id="h3a" />
            </div>
          </div>

          <p class="muted" style="margin-top:8px">
            Solicita dentro de 72 h posteriores al evento. Adjunta evidencia al entregarlo con tu tutor/coordinación.
          </p>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar PDF</button></div>
        </form>
        <div id="outJustificante" class="status"></div>
      </div>
    </section>

    <!-- RESIDENCIAS -->
    <section id="tab-residencias" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Generar solicitud de residencias</h2>
        <form id="formResidencias">
          <input type="hidden" id="tipoR" value="residencias_solicitud" />

          <label for="nombreR">Nombre completo</label>
          <input id="nombreR" required />

          <label for="empresaR">Empresa</label>
          <input id="empresaR" />

          <label for="proyectoR">Proyecto</label>
          <input id="proyectoR" />

          <p class="muted">Además de esta solicitud, adjuntar Carta de presentación, Anteproyecto, Carta de agradecimiento y Kardex.</p>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar solicitud</button></div>
        </form>
        <div id="outResidencias" class="status"></div>
      </div>
    </section>

    <!-- SOLICITUD DE TITULACIÓN -->
    <section id="tab-titulacion" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Generar solicitud de titulación</h2>
        <form id="formTitulacion">
          <input type="hidden" id="tipoT" value="titulacion_solicitud" />

          <label for="planT">Plan de estudios</label>
          <select id="planT">
            <option value="plan2004">Plan 2004</option>
            <option value="plan2010">Plan 2010</option>
          </select>

          <label for="opcionT">Opción de titulación</label>
          <select id="opcionT"></select>
          <div id="opcionHintT" class="muted" style="margin-top:6px"></div>

          <div class="row">
            <div>
              <label for="apPatT">Apellido paterno</label>
              <input id="apPatT" required />
            </div>
            <div>
              <label for="apMatT">Apellido materno</label>
              <input id="apMatT" />
            </div>
          </div>

          <label for="nombresT">Nombres</label>
          <input id="nombresT" required />

          <div class="row">
            <div>
              <label for="carreraT">Carrera</label>
              <input id="carreraT" placeholder="Ing. Industrial" />
            </div>
            <div>
              <label for="tramiteT">Trámite</label>
              <select id="tramiteT">
                <option value="primera_vez">Primera vez</option>
                <option value="reinicio">Reinicio</option>
              </select>
            </div>
          </div>

          <label for="numControlT">Número de control</label>
          <input id="numControlT" />

          <h3 class="title" style="margin-top:12px">Datos de contacto</h3>
          <label for="domT">Domicilio</label>
          <input id="domT" />
          <div class="row">
            <div>
              <label for="correoTT">Correo electrónico</label>
              <input id="correoTT" type="email" />
            </div>
            <div>
              <label for="telCasaT">Teléfono de casa</label>
              <input id="telCasaT" />
            </div>
          </div>
          <label for="telCelT">Teléfono celular</label>
          <input id="telCelT" />

          <div id="proyectoBoxT" class="hidden" style="margin-top:12px">
            <label for="proyectoT">Nombre del proyecto (si aplica)</label>
            <input id="proyectoT" placeholder="No aplica para EGEL" />
          </div>

          <p class="muted">El PDF se llenará únicamente hasta “SOLICITÓ CANDIDATO (A)”.</p>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar solicitud</button></div>
        </form>
        <div id="outTitulacion" class="status"></div>
      </div>
    </section>

    <!-- SEGUIMIENTO -->
    <section id="tab-seguimiento" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Seguimiento de titulación</h2>
        <form id="formEstadoTit">
          <div class="row">
            <div>
              <label for="estadoNumCtrl">Número de control</label>
              <input id="estadoNumCtrl" required />
            </div>
            <div>
              <label for="estadoTipo">Verificar con</label>
              <select id="estadoTipo">
                <option value="apellido">Apellido paterno</option>
                <option value="nss3">NSS (últimos 3)</option>
              </select>
            </div>
          </div>
          <label for="estadoValor">Valor del verificador</label>
          <input id="estadoValor" placeholder="ej. lopez / 527" />
          <div style="margin-top:12px"><button class="btn" type="submit">Consultar</button></div>
        </form>
        <div id="outEstadoTit" class="status"></div>
      </div>
    </section>

    <!-- REGISTRO DE PROYECTO (ANEXO I) -->
    <section id="tab-anexo1" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Registro de Proyecto — Anexo I</h2>
        <form id="formAnexo1">
          <input type="hidden" id="tipoA1" value="titulacion_registro_proyecto" />
          <h3 class="title">Datos generales</h3>
          <label for="a1Proyecto">Nombre del Proyecto</label>
          <input id="a1Proyecto" />
          <label for="a1Asesor">Nombre del Asesor(a)</label>
          <input id="a1Asesor" />
          <label for="a1NumEst">No. de Estudiantes</label>
          <input id="a1NumEst" type="number" min="1" />
          <h3 class="title">Participantes (egresados)</h3>
          <p class="muted">Un estudiante por línea: <em>Nombre completo | No. de control | Carrera</em></p>
          <textarea id="a1Participantes" rows="5" placeholder="Nombre Apellido | A00-0000 | Ing. Industrial&#10;..."></textarea>
          <label for="a1Obs">Observaciones</label>
          <textarea id="a1Obs" rows="3"></textarea>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar Anexo I (PDF)</button></div>
        </form>
        <div id="outAnexo1" class="status"></div>
      </div>
    </section>

    <!-- REPORTE DE ASESORÍAS -->
    <section id="tab-asesorias" class="tabpage hidden">
      <div class="card">
        <h2 class="title">Reporte de Seguimiento de Asesorías</h2>
        <form id="formAsesorias">
          <input type="hidden" id="tipoAs" value="titulacion_asesorias_reporte" />
          <div class="row">
            <div>
              <label for="asProyecto">Proyecto</label>
              <input id="asProyecto" />
            </div>
            <div>
              <label for="asAsesor">Asesor interno</label>
              <input id="asAsesor" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="asAlumno">Alumno(a)</label>
              <input id="asAlumno" />
            </div>
            <div>
              <label for="asControl">Número de control</label>
              <input id="asControl" />
            </div>
          </div>
          <h3 class="title">Sesión</h3>
          <div class="row">
            <div>
              <label for="asNum">No. de sesión</label>
              <input id="asNum" type="number" min="1" />
            </div>
            <div>
              <label for="asFecha">Fecha</label>
              <input id="asFecha" type="date" />
            </div>
          </div>
          <label for="asAcuerdos">Acuerdos / Avances</label>
          <textarea id="asAcuerdos" rows="4"></textarea>
          <label for="asObserv">Observaciones</label>
          <textarea id="asObserv" rows="3"></textarea>
          <div style="margin-top:12px"><button class="btn" type="submit">Generar reporte (PDF)</button></div>
        </form>
        <div id="outAsesorias" class="status"></div>
      </div>
    </section>

    <p class="muted">Privacidad: esta página no publica horarios de docentes ni listados de grupos. Solo procesos y formatos.</p>
  <!-- ============= SCRIPTS ============= -->
  <script>
    /* ---------- CONST: Webhook n8n (embebido) ---------- */
    const WURL_FORMATOS = 'https://discover-surveillance-maximize-thesaurus.trycloudflare.com/webhook/formatos';

    /* ---------- TABS ---------- */
    const tabs = document.querySelectorAll('.tab');
    const pages = document.querySelectorAll('.tabpage');
    function showTab(id){
      pages.forEach(p => p.classList.add('hidden'));
      document.getElementById(id)?.classList.remove('hidden');
      tabs.forEach(b => b.classList.toggle('active', b.dataset.tab === id));
    }
    tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));
    // Tab por defecto
    showTab('tab-chat');

    /* ---------- HELPERS ---------- */
    const $ = (id) => document.getElementById(id);
    async function postJSON(url, body){
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }
    function linkOK(d){
      return d?.ok ? `✅ <a href="${d.fileUrl}" target="_blank" rel="noopener">Descargar</a>` : 'Error en servidor';
    }

    /* ---------- JUSTIFICANTE ---------- */
    $('formJustificante')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = $('outJustificante');
      const payload = {
        tipo: 'justificante',
        nombre: $('nombreJ').value,
        numero_control: $('numControlJ').value,
        motivo: $('motivoJ').value,
        fecha: $('fechaJ').value,
        asignaturas: $('asignaturasJ').value,
        // Días/mes/horario (3 filas)
        d1del: $('d1del').value, d1al: $('d1al').value, mes1: $('mes1').value,
        h1de: $('h1de').value,   h1a:  $('h1a').value,
        d2del: $('d2del').value, d2al: $('d2al').value, mes2: $('mes2').value,
        h2de: $('h2de').value,   h2a:  $('h2a').value,
        d3del: $('d3del').value, d3al: $('d3al').value, mes3: $('mes3').value,
        h3de: $('h3de').value,   h3a:  $('h3a').value
      };
      out.textContent = 'Generando…';
      try{
        const d = await postJSON(WURL_FORMATOS, payload);
        out.innerHTML = linkOK(d);
      }catch(err){ out.textContent = 'Error: '+(err.message||err); }
    });

    /* ---------- RESIDENCIAS (solicitud) ---------- */
    $('formResidencias')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = $('outResidencias');
      const payload = {
        tipo: 'residencias_solicitud',
        nombre: $('nombreR').value,
        empresa: $('empresaR').value,
        proyecto: $('proyectoR').value
      };
      out.textContent = 'Generando…';
      try{
        const d = await postJSON(WURL_FORMATOS, payload);
        out.innerHTML = linkOK(d);
      }catch(err){ out.textContent = 'Error: '+(err.message||err); }
    });

    /* ---------- TITULACIÓN (solicitud) ---------- */
    const OPCIONES_2004 = [
      {v:'tesis', t:'Tesis'},
      {v:'material_didactico', t:'Elaboración de texto o materiales didácticos'},
      {v:'proyecto_investigacion', t:'Proyecto de investigación'},
      {v:'curso_especial', t:'Curso especial de titulación'},
      {v:'examen_areas_na', t:'Examen por áreas de conocimiento (N/A)'},
      {v:'memoria_experiencia', t:'Memoria de experiencia profesional'},
      {v:'escolaridad_na', t:'Escolaridad (N/A)'},
      {v:'creditos_posgrado_na', t:'Créditos de posgrado (N/A)'},
      {v:'memoria_residencia', t:'Memoria de residencia profesional'},
      {v:'titulacion_integrada', t:'Titulación Integrada'}
    ];
    const OPCIONES_2010 = [
      {v:'tesis_tesina', t:'Tesis o Tesina'},
      {v:'innovacion_tecnologica', t:'Proyecto de Innovación Tecnológica'},
      {v:'inv_o_desarrollo_tec', t:'Investigación / Desarrollo Tecnológico'},
      {v:'emprendedurismo', t:'Proyecto de Emprendedurismo'},
      {v:'examen_areas_egel_na', t:'Examen por áreas (EGEL, N/A)'},
      {v:'estancia', t:'Estancia'},
      {v:'proyecto_integrador', t:'Proyecto Integrador'},
      {v:'proyecto_productivo', t:'Proyecto Productivo'},
      {v:'memoria_residencia', t:'Memoria de residencia profesional'},
      {v:'dual', t:'Proyecto Integral de Educación Dual'}
    ];
    const HINTS_OPCION = {
      examen_areas_na:'Marcado como N/A; verificar políticas vigentes.',
      escolaridad_na:'Marcado como N/A.',
      creditos_posgrado_na:'Marcado como N/A.',
      examen_areas_egel_na:'Marcado como N/A (EGEL).',
      memoria_residencia:'Basado en el informe de residencias y su liberación.'
    };

    function renderOpciones(){
      const selPlan = $('planT'), selOpcion = $('opcionT');
      if(!selPlan || !selOpcion) return;
      const list = selPlan.value === 'plan2010' ? OPCIONES_2010 : OPCIONES_2004;
      selOpcion.innerHTML = '';
      list.forEach(opt=>{
        const o=document.createElement('option'); o.value=opt.v; o.textContent=opt.t; selOpcion.appendChild(o);
      });
      updateOpcionHint();
    }
    function updateOpcionHint(){
      const selOpcion = $('opcionT'), hint = $('opcionHintT'), box=$('proyectoBoxT');
      if(!selOpcion || !hint) return;
      const v = selOpcion.value;
      hint.textContent = HINTS_OPCION[v] || '';
      const esEGEL = (v === 'examen_areas_na' || v === 'examen_areas_egel_na');
      box?.classList.toggle('hidden', esEGEL);
    }
    $('planT')?.addEventListener('change', renderOpciones);
    $('opcionT')?.addEventListener('change', updateOpcionHint);
    renderOpciones();

    $('formTitulacion')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = $('outTitulacion');
      const payload = {
        tipo: 'titulacion_solicitud',
        plan: $('planT').value,
        opcion: $('opcionT').value,
        ap_paterno: $('apPatT').value,
        ap_materno: $('apMatT').value,
        nombres:   $('nombresT').value,
        carrera:   $('carreraT').value,
        tramite:   $('tramiteT').value,
        numero_control: $('numControlT').value,
        domicilio: $('domT').value,
        correo:    $('correoTT').value,
        tel_casa:  $('telCasaT').value,
        tel_cel:   $('telCelT').value,
        nombre_proyecto: ($('proyectoBoxT')?.classList.contains('hidden') ? '' : ($('proyectoT').value||''))
      };
      out.textContent = 'Generando…';
      try{
        const d = await postJSON(WURL_FORMATOS, payload);
        out.innerHTML = linkOK(d);
      }catch(err){ out.textContent = 'Error: '+(err.message||err); }
    });

    /* ---------- SEGUIMIENTO (solo prepara payload; el endpoint lo puedes conectar cuando lo tengas) ---------- */
    $('formEstadoTit')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = $('outEstadoTit');
      out.textContent = 'Consulta no habilitada aún desde este índice.';
      // Cuando tengas endpoint, cambia a:
      // const d = await postJSON(WURL_FORMATOS, { tipo:'titulacion_estado', ... });
      // out.innerHTML = d?.ok ? ... : 'Sin resultados';
    });

    /* ---------- ANEXO I ---------- */
    $('formAnexo1')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = $('outAnexo1');
      const payload = {
        tipo: 'titulacion_registro_proyecto',
        proyecto: $('a1Proyecto').value,
        asesor: $('a1Asesor').value,
        num_estudiantes: $('a1NumEst').value,
        participantes: $('a1Participantes').value,
        observaciones: $('a1Obs').value
      };
      out.textContent = 'Generando…';
      try{
        const d = await postJSON(WURL_FORMATOS, payload);
        out.innerHTML = linkOK(d);
      }catch(err){ out.textContent = 'Error: '+(err.message||err); }
    });

    /* ---------- ASESORÍAS ---------- */
    $('formAsesorias')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const out = $('outAsesorias');
      const payload = {
        tipo: 'titulacion_asesorias_reporte',
        proyecto: $('asProyecto').value,
        asesor_interno: $('asAsesor').value,
        alumno: $('asAlumno').value,
        numero_control: $('asControl').value,
        sesion_num: $('asNum').value,
        sesion_fecha: $('asFecha').value,
        acuerdos: $('asAcuerdos').value,
        observaciones: $('asObserv').value
      };
      out.textContent = 'Generando…';
      try{
        const d = await postJSON(WURL_FORMATOS, payload);
        out.innerHTML = linkOK(d);
      }catch(err){ out.textContent = 'Error: '+(err.message||err); }
    });

    /* ---------- CHAT (placeholder) ---------- */
    // Si más adelante quieres conectar el chat a otro webhook,
    // agrega aquí el fetch correspondiente.
  </script>
</body>
</html>
